<!DOCTYPE html>
<html>

<head>
  <title>Reproductor YouTube + Cast (Corregido)</title>
  <style>
    #castButton {
      background: #ff0000;
      color: white;
      padding: 15px;
      cursor: pointer;
    }
  </style>
  <!-- Carga las APIs necesarias -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
</head>

<body>
  <button id="castButton" onclick="initializeCast()">TRANSMITIR AL TV ðŸ”´</button>
  <div id="player"></div>

  <script>
    const videoId = 'dQw4w9WgXcQ'; // ID de Rick Astley
    let player;
    let castSession = null;

    // 1. Inicializa el reproductor de YouTube
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        videoId: videoId,
        playerVars: {
          enablejsapi: 1,
          origin: window.location.origin // Usa tu URL de Netlify
        }
      });
    }

    // 2. Inicializa la API de Cast
    function initializeCast() {
      if (!chrome.cast || !chrome.cast.isAvailable) {
        alert("Actualiza Chrome o no uses modo incÃ³gnito.");
        return;
      }

      const sessionRequest = new chrome.cast.SessionRequest(
        chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID
      );

      const apiConfig = new chrome.cast.ApiConfig(
        sessionRequest,
        session => {
          castSession = session;
          startCasting();
        },
        receiverAvailability => {
          if (receiverAvailability === chrome.cast.ReceiverAvailability.AVAILABLE) {
            console.log("Dispositivo Cast detectado âœ…");
          }
        }
      );

      // Inicializa la API de forma asÃ­ncrona
      chrome.cast.initialize(
        apiConfig,
        () => console.log("API de Cast inicializada âœ…"),
        error => console.error("Error al inicializar Cast:", error)
      );
    }

    // 3. FunciÃ³n para transmitir el video
    async function startCasting() {
      try {
        if (!castSession) {
          throw new Error("SesiÃ³n Cast no iniciada");
        }

        const mediaInfo = new chrome.cast.media.MediaInfo(
          `https://www.youtube.com/watch?v=${videoId}`,
          'video/youtube'
        );

        const request = new chrome.cast.media.LoadRequest(mediaInfo);

        // Transmite el video
        await castSession.loadMedia(request);
        console.log("Â¡TransmisiÃ³n exitosa! ðŸ“¡");

      } catch (error) {
        console.error("Error al transmitir:", error);
        alert("Error: " + error.message);
      }
    }
  </script>
</body>

</html>